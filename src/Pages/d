import React, { useState, useEffect } from 'react';
import styled from 'styled-components';
import Entry from '../Components/InputBox';
import DistrictDropdown from '../Components/DistictDopDown';
import ListPlaces from '../Components/Places/ListPlaces';
import ImagePicker from '../Components/ImagePicker';
import { post } from '../actions/api';
import PlacesDropDown from '../Components/PlacesDropDown';

const districtsData = [
  { name: "Thiruvananthapuram", id: 0 },
  { name: "Kollam", id: 1 },
  { name: "Pathanamthitta", id: 2 },
  { name: "Alappuzha", id: 3 },
  { name: "Kottayam", id: 4 },
  { name: "Idukki", id: 5 },
  { name: "Ernakulam", id: 6 },
  { name: "Thrissur", id: 7 },
  { name: "Palakkad", id: 8 },
  { name: "Malappuram", id: 9 },
  { name: "Kozhikode", id: 10 },
  { name: "Wayanad", id: 11 },
  { name: "Kannur", id: 12 },
  { name: "Kasaragod", id: 13 },
];

const Hotels = () => {
  const [districts] = useState(districtsData);
  const [selectedDistrict, setSelectedDistrict] = useState(null);
  const [places, setPlaces] = useState([]);
  const [selectedPlace, setSelectedPlace] = useState(null);
  const [formData, setFormData] = useState({});
  const [base64Image, setBase64Image] = useState(null);
  const [isFormValid, setIsFormValid] = useState(false);

  useEffect(() => {
    if (selectedDistrict) {
      post('places/getPlaceByDistrict', {
        districtId: selectedDistrict,
      })
        .then((res) => {
          setPlaces(res.data);
        })
        .catch((error) => {
          console.error('Error fetching places:', error);s
        });
    }
  }, [selectedDistrict]);

  useEffect(() => {
    validateForm();
  }, [formData, selectedDistrict, selectedPlace, base64Image]);

  const validateForm = () => {
    const requiredFields = ['name', 'description', 'address', 'contactNumber', 'price'];
    const allFieldsFilled = requiredFields.every((field) => formData[field]);

    setIsFormValid(
      selectedDistrict && selectedPlace && allFieldsFilled && base64Image
    );
  };

  const handleFieldChange = (name, value) => {
    setFormData({
      ...formData,
      [name]: value,
    });
  };

  const handleSubmit = () => {
    if (!isFormValid) {
      alert('Please fill in all required fields.');
      return;
    }

    const dataToSend = {
      ...formData,
      districtId: selectedDistrict,
      placeId: selectedPlace,
      image: base64Image,
    };

    post('/hotels/register', dataToSend)
      .then((res) => {
        console.log('Successfully registered:', res);
        resetForm();
      })
      .catch((error) => {
        console.error('Error during registration:', error);
      });
  };

  const resetForm = () => {
    setFormData({});
    setBase64Image(null);
    setSelectedDistrict(null);
    setSelectedPlace(null);
  };

  return (
    <MainContainer>
      <FormContainer>
        <FormContainerInner>
          <div style={{ display: 'flex', gap: '1em' }}>
            <div style={{ flex: 1 }}>
              <p>District*</p>
              <DistrictDropdown
                districts={districts}
                onChange={(e) => setSelectedDistrict(e.target.value)}
                selectedDistrict={selectedDistrict}
              />
            </div>

            <div style={{ flex: 1 }}>
              <p>Place*</p>
              <PlacesDropDown
                places={places}
                onChange={(e) => setSelectedPlace(e.target.value)}
                selectedPlace={selectedPlace}
              />
            </div>
          </div>

          <Entry
            data={formData}
            title="Hotel Name*"
            name="name"
            setData={handleFieldChange}
          />

          <Entry
            data={formData}
            title="Description*"
            name="description"
            setData={handleFieldChange}
          />

          <Entry
            data={formData}
            title="Address*"
            name="address"
            setData={handleFieldChange}
          />

          <Entry
            data={formData}
            title="Contact Number*"
            name="contactNumber"
            setData={handleFieldChange}
          />

          <div style={{ display: 'flex', gap: '1em' }}>
            <Entry
              data={formData}
              title="Price*"
              name="price"
              setData={handleFieldChange}
            />
          </div>

          <div style={{ display: 'flex', flexDirection: 'column' }}>
            <p>Place Image*</p>
            <ImagePicker
              base64Image={base64Image}
              setBase64Image={setBase64Image}
            />
          </div>

          <div style={{ width: '100%', marginTop: '1em' }}>
            <button onClick={handleSubmit} disabled={!isFormValid}>
              Submit
            </button>
          </div>
        </FormContainerInner>
      </FormContainer>

      <ListContainer>
        <ListPlaces apiUrl={'hotels'} />
      </ListContainer>
    </MainContainer>
  );
};

export default Hotels;

const MainContainer = styled.div`
  display: flex;
  gap: 0.8em;
`;

const FormContainer = styled.div`
  flex: 1;
  background-color: white;
  box-shadow: 0 0 5px #5e72e4;
  padding: 1em;
  border-radius: 10px;
  overflow-y: scroll;
`;

const FormContainerInner = styled.div`
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1em;
`;

const ListContainer = styled.div`
  flex: 1;
  background-color: white;
  box-shadow: 0 0 5px #5e72e4;
  padding: 1em;
  border-radius: 10px;
  overflow-y: scroll;
`;
